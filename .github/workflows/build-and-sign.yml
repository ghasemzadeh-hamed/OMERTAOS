name: build-and-sign

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      VAULT_ENABLED: ${{ vars.VAULT_ENABLED || 'false' }}
      VAULT_ADDR: ${{ vars.VAULT_ADDR || 'http://127.0.0.1:8200' }}
      VAULT_AUTH_METHOD: ${{ vars.VAULT_AUTH_METHOD || 'token' }}
      VAULT_TOKEN: ${{ secrets.VAULT_TOKEN || vars.VAULT_TOKEN || '' }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Vault CLI
        if: env.VAULT_ENABLED == 'true'
        uses: eLco/setup-vault@v1
        with:
          vault_version: '1.16.3'

      - name: Render secrets to files (Vault Agent)
        if: env.VAULT_ENABLED == 'true'
        env:
          VAULT_TOKEN: ${{ env.VAULT_TOKEN }}
        run: |
          set -euo pipefail
          : "${VAULT_TOKEN:?VAULT_TOKEN must be set when VAULT_ENABLED is true}"
          mkdir -p .secrets-out
          cat > agent.hcl <<'HCL'
          exit_after_auth = true
          pid_file = "./vault-agent.pid"

          auto_auth {
            method "token" {
              config = {
                token = "${VAULT_TOKEN}"
              }
            }
            sink "file" {
              config = {
                path = "./vault-agent-token"
              }
            }
          }

          template {
            source      = "templates/cosign.hcl.tpl"
            destination = ".secrets-out/cosign.password"
          }
          HCL

          vault agent -config=agent.hcl -once
          COSIGN_PASSWORD_FILE="${PWD}/.secrets-out/cosign.password"
          : "$(cat "${COSIGN_PASSWORD_FILE}")"
          printf 'COSIGN_PASSWORD_FILE=%s\n' "${COSIGN_PASSWORD_FILE}" >> "${GITHUB_ENV}"
          printf 'COSIGN_PASSWORD=%s\n' "$(cat "${COSIGN_PASSWORD_FILE}")" >> "${GITHUB_ENV}"
          rm -f agent.hcl vault-agent-token

      - name: Install cosign
        if: env.VAULT_ENABLED == 'true'
        uses: sigstore/cosign-installer@v3.5.0

      - name: Generate cosign keys and sign
        if: env.VAULT_ENABLED == 'true'
        env:
          COSIGN_PASSWORD: ${{ env.COSIGN_PASSWORD }}
        run: |
          set -euo pipefail
          : "${COSIGN_PASSWORD:?COSIGN_PASSWORD is empty}"

          mkdir -p .artifacts
          ( cd .artifacts && cosign generate-key-pair --yes )

          cosign sign-blob \
            --key .artifacts/cosign.key \
            --output-signature .artifacts/control-server.pem.sig \
            config/certs/control-server.pem

      - name: Upload artifacts
        if: env.VAULT_ENABLED == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: cosign-artifacts
          path: .artifacts/*
