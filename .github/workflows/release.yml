name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Generate changelog
        run: git log -1 --pretty=fuller > CHANGELOG.txt
      - name: Build gateway image
        run: |
          docker build -t ghcr.io/aionos/gateway:${GITHUB_REF_NAME} gateway
      - name: Build control image
        run: |
          docker build -t ghcr.io/aionos/control:${GITHUB_REF_NAME} control
      - name: Cosign images
        run: |
          cosign sign --key cosign.key ghcr.io/aionos/gateway:${GITHUB_REF_NAME}
          cosign sign --key cosign.key ghcr.io/aionos/control:${GITHUB_REF_NAME}
      - name: Publish ORAS modules
        run: |
          oras push ghcr.io/aionos/modules/summarize_text:${GITHUB_REF_NAME} ./modules/summarize_text/manifest.yaml
      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            CHANGELOG.txt
            sbom.spdx.json
